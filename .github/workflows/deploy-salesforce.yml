name: Salesforce Deployment to Kubernetes

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:

      # Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Authenticate GCP
      - name: Setup GCP credentials
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      # Setup kubectl
      - name: Install kubectl
        run: |
         curl -LO "https://dl.k8s.io/release/v1.30.0/bin/linux/amd64/kubectl"
         chmod +x kubectl
         sudo mv kubectl /usr/local/bin/


      # Get GKE credentials
      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials jpcluster \
            --zone us-central1-a \
            --project grand-forge-472709-a0

      # Delete old Jobs to free resources
      - name: Cleanup old Salesforce Jobs
        run: |
          kubectl delete jobs -l app=salesforce-deploy --ignore-not-found=true -n default

      # Apply ConfigMap & Secret
      - name: Apply ConfigMap and Secret
        run: |
          kubectl apply -f kubernetes/base/configmap.yaml -n default
          kubectl apply -f kubernetes/base/secret-salesforce.yaml -n default

      # Create new Salesforce deployment Job
      - name: Deploy Salesforce to Kubernetes
        run: |
          kubectl create -f kubernetes/base/job-deploy.yaml -n default

      # Wait until Job completes
      - name: Wait for Job Completion
        run: |
          kubectl wait --for=condition=complete job -l app=salesforce-deploy -n default --timeout=600s

      # Print logs
      - name: Print Job logs
        run: |
          POD_NAME=$(kubectl get pods -l job-name=$(kubectl get jobs -l app=salesforce-deploy -o jsonpath='{.items[0].metadata.name}') -o jsonpath='{.items[0].metadata.name}')
          kubectl logs $POD_NAME -n default
        