apiVersion: batch/v1
kind: Job
metadata:
  name: salesforce-deploy
spec:
  template:
    spec:
      containers:
      - name: sf-cli
        image: ghcr.io/salesforce/sfdx:latest
        env:
          - name: SF_USERNAME
            valueFrom:
              secretKeyRef:
                name: salesforce-secret
                key: SF_USERNAME
          - name: SF_CLIENT_ID
            valueFrom:
              secretKeyRef:
                name: salesforce-secret
                key: SF_CLIENT_ID
          - name: SF_LOGIN_URL
            valueFrom:
              configMapKeyRef:
                name: salesforce-config
                key: SF_LOGIN_URL
          - name: SF_ALIAS
            valueFrom:
              configMapKeyRef:
                name: salesforce-config
                key: SF_ALIAS
          - name: SF_TEST_LEVEL
            valueFrom:
              configMapKeyRef:
                name: salesforce-config
                key: SF_TEST_LEVEL
        command: ["/bin/sh", "-c"]
        args:
          - |
            echo "Starting Salesforce Deployment..."
            sf project deploy start \
              --target-org $SF_ALIAS \
              --jwt-key-file /certs/server.key \
              --client-id $SF_CLIENT_ID \
              --test-level $SF_TEST_LEVEL \
              --json
            echo "Deployment completed."
        volumeMounts:
          - name: salesforce-key
            mountPath: /certs
            readOnly: true
      restartPolicy: Never
      volumes:
        - name: salesforce-key
          secret:
            secretName: salesforce-key
  backoffLimit: 0
